<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Virtual Try-On</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inria+Sans:wght@300;400;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inria Sans', sans-serif;
      margin: 0;
      padding: 0;
      background: #fffefe;
    }

    h1 {
      text-align: left;
      color: #333;
      margin-bottom: 20px;
      width: calc(100vw - 40px);
    }

    .container {
      background: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .video-wrapper {
      display: grid;
      grid-template-columns: auto 1fr;
      gap: 40px;
      align-items: start;
      margin-bottom: 20px;
    }

    .video-container {
      position: relative;
      background: #000;
      border-radius: 4px;
      overflow: visible;
      aspect-ratio: 704 / 1280;
      max-height: calc(100vh - 150px);
      max-width: 90vw;
      width: auto;
      height: auto;
      margin: 0 auto;
    }

    .side-button {
      width: 100px;
      height: 100px;
      padding: 10px;
      border: 2px solid #dc3545;
      border-radius: 8px;
      background: white;
      color: #dc3545;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      white-space: normal;
      word-wrap: break-word;
    }

    .side-button:hover {
      background: #dc3545;
      color: white;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(220, 53, 69, 0.3);
    }

    .side-button:active {
      transform: translateY(0);
    }

    video {
      aspect-ratio: 704 / 1280;
      max-height: calc(100vh - 150px);
      max-width: 90vw;
      width: auto;
      height: auto;
      display: block;
      object-fit: contain;
      margin: 0 auto;
    }

    .controls {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    input[type="file"],
    input[type="text"] {
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }

    input[type="text"] {
      width: 100%;
      box-sizing: border-box;
    }

    #status {
      padding: 10px;
      background: #f0f0f0;
      border-radius: 4px;
      text-align: center;
      font-weight: 500;
      color: #666;
    }

    .note {
      margin-top: 20px;
      padding: 10px;
      background: #fff3cd;
      border: 1px solid #ffc107;
      border-radius: 4px;
      font-size: 14px;
      color: #856404;
    }

    .button-grid {
      position: absolute;
      top: 10px;
      right: 10px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      z-index: 10;
    }

    .video-section {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .view-button {
      width: 50px;
      height: 50px;
      max-width: 50px;
      max-height: 50px;
      padding: 0;
      border: none;
      border-radius: 8px;
      background: transparent;
      font-size: 10px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .view-button:hover:not(:disabled) {
      background: rgba(0, 123, 255, 0.95);
      color: white;
      transform: scale(1.05);
      box-shadow: 0 4px 8px rgba(0, 123, 255, 0.5);
    }

    .view-button:active:not(:disabled) {
      transform: scale(0.95);
    }

    .view-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      border-color: #ccc;
      color: #999;
    }

    .view-button img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      display: block;
      border-radius: 8px;
    }

    .model-selection {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      width: calc(100vw - 40px);
      height: calc(100vh - 120px);
      gap: 0px;
    }

    .model-button {
      border: none;
      background: transparent;
      padding: 0;
      cursor: pointer;
      transition: all 0.3s;
      overflow: hidden;
      height: 100%;
    }

    .model-button:hover {
      transform: scale(1.02);
      box-shadow: 0 8px 16px rgba(0, 123, 255, 0.2);
    }

    .model-button:active {
      transform: scale(0.98);
    }

    .model-button img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .left-buttons {
      display: flex;
      flex-direction: column;
      gap: 20px;
      align-items: flex-start;
      padding: 10px;
      max-height: 80vh;
      overflow-y: auto;
    }

    .clothing-category {
      width: 100%;
    }

    .category-header {
      font-size: 14px;
      font-weight: 600;
      color: #333;
      margin-bottom: 8px;
      text-transform: capitalize;
      padding-bottom: 4px;
    }

    .clothing-items {
      display: flex;
      flex-direction: row;
      gap: 10px;
      flex-wrap: wrap;
    }

    .clothing-button {
      border: none;
      border-radius: 8px;
      padding: 0;
      background: transparent;
      cursor: pointer;
      transition: all 0.3s;
      width: 120px;
      height: 120px;
      overflow: hidden;
    }

    .clothing-button:hover {
      transform: scale(1.1);
      box-shadow: 0 4px 8px rgba(0, 123, 255, 0.3);
    }

    .clothing-button:active {
      transform: scale(0.95);
    }

    .clothing-button img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 6px;
      display: block;
    }

    .home-page {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 20px;
      box-sizing: border-box;
    }
  </style>
</head>

<body>
  <div class="home-page" id="modelSelection">
    <h1>VIRTUAL TRY-ON <span style="font-size: 12px;">(Powered by Odyssey.ml)</span></h1>

    <!-- Model Selection -->
    <div class="model-selection">
      <button class="model-button" id="femaleModelBtn">
        <img src="./assets/female/female_model.png" alt="Female Model">
      </button>
      <button class="model-button" id="maleModelBtn">
        <img src="./assets/male/male_model.png" alt="Male Model">
      </button>
    </div>
  </div>

  <!-- Video Screen -->
  <div id="videoScreen" class="container" style="display: none;">
    <h1>VIRTUAL TRY-ON <span style="font-size: 12px;">(Powered by Odyssey.ml)</span></h1>
    <div class="video-wrapper">
      <!-- Left Column: Clothing Buttons -->
      <div class="left-buttons" id="clothingGrid">
        <!-- Dynamically populated from clothing-config.json -->
      </div>

      <!-- Right Column: Video and Movement Controls -->
      <div class="video-section">
        <div class="video-container">
          <video id="video" autoplay playsinline muted></video>
          <div class="button-grid">
            <button class="view-button" id="frontBtn">
              <img src="./assets/movement_buttons/face_forward.png" alt="face-forward">
            </button>
            <button class="view-button" id="backBtn">
              <img src="./assets/movement_buttons/figure_rotating.png" alt="turn-around">
            </button>
            <button class="view-button" id="sideBtn">
              <img src="./assets/movement_buttons/profile_view.png" alt="face-sidewards">
            </button>

            <!-- <button class="view-button" id="walkBtn">Walk</button> -->
          </div>
        </div>
      </div>
    </div>

    <div class="controls">
      <input type="text" id="promptInput" placeholder="Custom prompt (optional, e.g., 'Person trying on a red jacket')"
        aria-label="Custom prompt">
    </div>
  </div>

  <script type="module">
    import { Odyssey } from 'https://esm.sh/@odysseyml/odyssey@1.0.0';

    // ===== CONFIGURATION =====
    // Replace this with your actual Odyssey API key
    const API_KEY = 'ody_sjVzTgXISZa3HdoaCBHepQsy8UrKc6Rz';
    // const API_KEY = 'ody_';

    // ===== STATE VARIABLES =====
    let isConnected = false;
    let hasImage = false;
    let uploadedImage = null;
    let isStreaming = false;
    let selectedGender = 'female';
    let clothingConfig = null;

    // ===== DOM REFERENCES =====
    const videoEl = document.getElementById('video');
    const promptInput = document.getElementById('promptInput');
    const frontBtn = document.getElementById('frontBtn');
    const backBtn = document.getElementById('backBtn');
    const sideBtn = document.getElementById('sideBtn');
    // const walkBtn = document.getElementById('walkBtn');
    const modelSelection = document.getElementById('modelSelection');
    const videoScreen = document.getElementById('videoScreen');
    const femaleModelBtn = document.getElementById('femaleModelBtn');
    const maleModelBtn = document.getElementById('maleModelBtn');
    const clothingGrid = document.getElementById('clothingGrid');

    // ===== CLEAR INPUTS ON PAGE LOAD =====
    promptInput.value = '';

    // ===== CREATE CLIENT =====
    const client = new Odyssey({ apiKey: API_KEY });

    // ===== AUTO-START LOGIC =====
    function checkAutoStart() {
      if (isConnected && hasImage && !isStreaming && uploadedImage) {
        startStream();
      }
    }

    // ===== BUTTON STATE MANAGEMENT =====
    function updateButtonStates() {
      const buttons = [frontBtn, backBtn, sideBtn];
      buttons.forEach(btn => {
        btn.disabled = !isStreaming;
      });
    }

    async function startStream() {
      try {
        const prompt = promptInput.value.trim() || "Person standing";

        console.log('Starting stream with prompt:', prompt);

        const streamId = await client.startStream({
          prompt: prompt,
          portrait: true,
          image: uploadedImage
        });

        console.log('Stream started with ID:', streamId);
      } catch (error) {
        console.error('Failed to start stream:', error);
        alert(`Failed to start stream: ${error.message}`);
      }
    }

    // ===== MODEL SELECTION HANDLERS =====
    async function loadImageAsFile(imagePath) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.crossOrigin = 'anonymous';

        img.onload = () => {
          // Create canvas and draw image
          const canvas = document.createElement('canvas');
          canvas.width = img.width;
          canvas.height = img.height;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0);

          // Convert canvas to blob
          canvas.toBlob((blob) => {
            if (blob) {
              const filename = imagePath.split('/').pop();
              const file = new File([blob], filename, { type: blob.type });
              resolve(file);
            } else {
              reject(new Error('Failed to convert image to blob'));
            }
          }, 'image/png');
        };

        img.onerror = () => {
          reject(new Error('Failed to load image'));
        };

        img.src = imagePath;
      });
    }

    // ===== LOAD CLOTHING CONFIG =====
    async function loadClothingConfig() {
      try {
        const response = await fetch('./clothing-config.json');
        clothingConfig = await response.json();
        console.log('Clothing config loaded:', clothingConfig);
      } catch (error) {
        console.error('Failed to load clothing config:', error);
      }
    }

    // ===== BUILD CLOTHING GRID =====
    function buildClothingGrid(gender) {
      if (!clothingConfig || !clothingConfig[gender]) {
        console.warn('No clothing config for gender:', gender);
        return;
      }

      clothingGrid.innerHTML = '';
      const genderConfig = clothingConfig[gender];

      // Iterate through each clothing category
      for (const [category, items] of Object.entries(genderConfig)) {
        // Create category section
        const categoryDiv = document.createElement('div');
        categoryDiv.className = 'clothing-category';

        // Create category header
        const header = document.createElement('div');
        header.className = 'category-header';
        header.textContent = category;
        categoryDiv.appendChild(header);

        // Create items container (even if empty)
        const itemsDiv = document.createElement('div');
        itemsDiv.className = 'clothing-items';

        // Create button for each item (if any)
        if (items && items.length > 0) {
          items.forEach((item, index) => {
            const button = document.createElement('button');
            button.className = 'clothing-button';

            const img = document.createElement('img');
            img.src = item.file;
            img.alt = `${category} ${index + 1}`;

            button.appendChild(img);

            // Add click handler
            button.addEventListener('click', () => applyClothing(item));

            itemsDiv.appendChild(button);
          });
        }

        categoryDiv.appendChild(itemsDiv);
        clothingGrid.appendChild(categoryDiv);
      }
    }

    // ===== APPLY CLOTHING =====
    async function applyClothing(item) {
      try {
        if (!isStreaming) {
          console.warn('No active stream to modify');
          alert('Please start a stream first');
          return;
        }

        console.log('Applying clothing:', item.prompt);

        await client.interact({
          prompt: item.prompt
        });

        console.log('Clothing applied successfully');

      } catch (error) {
        console.error('Failed to apply clothing:', error);
        alert(`Failed to apply clothing: ${error.message}`);
      }
    }

    async function selectModel(modelPath, modelName) {
      try {
        // Determine gender from model name
        selectedGender = modelName.toLowerCase().includes('female') ? 'female' : 'male';

        // Load the model image as a File
        const file = await loadImageAsFile(modelPath);

        // Store the file and update state
        uploadedImage = file;
        hasImage = true;

        console.log('Model selected:', modelName, `(${(file.size / 1024 / 1024).toFixed(2)}MB)`);

        // Build clothing grid for selected gender
        buildClothingGrid(selectedGender);

        // Switch to video screen
        modelSelection.style.display = 'none';
        videoScreen.style.display = 'block';

        // Try to auto-start if connected
        checkAutoStart();

      } catch (error) {
        console.error('Failed to select model:', error);
        alert(`Failed to load model: ${error.message}`);
      }
    }

    femaleModelBtn.addEventListener('click', () => selectModel('./assets/female/female_model.png', 'Female Model'));
    maleModelBtn.addEventListener('click', () => selectModel('./assets/male/male_model.png', 'Male Model'));

    // ===== PROMPT INPUT HANDLER =====
    promptInput.addEventListener('keydown', async (event) => {
      if (event.key === 'Enter') {
        event.preventDefault();

        const prompt = promptInput.value.trim();

        if (!prompt) {
          alert('Please enter a prompt');
          return;
        }

        if (!isStreaming) {
          alert('No active stream. Please upload an image first.');
          return;
        }

        try {
          console.log('Sending interact prompt:', prompt);

          await client.interact({
            prompt: prompt
          });

          console.log('Prompt sent successfully');
          promptInput.value = ''; // Clear the input

        } catch (error) {
          console.error('Failed to send prompt:', error);
          alert(`Failed to send prompt: ${error.message}`);
        }
      }
    });

    // ===== VIEW BUTTON HANDLERS =====
    async function sendViewPrompt(prompt) {
      try {
        console.log('Sending view prompt:', prompt);

        await client.interact({
          prompt: prompt
        });

        console.log('View prompt sent successfully');

      } catch (error) {
        console.error('Failed to send view prompt:', error);
        alert(`Failed to change view: ${error.message}`);
      }
    }

    frontBtn.addEventListener('click', () => sendViewPrompt('person faces forward'));
    backBtn.addEventListener('click', () => sendViewPrompt('person is turning around'));
    sideBtn.addEventListener('click', () => sendViewPrompt('person faces side show body profile view'));
    // walkBtn.addEventListener('click', () => sendViewPrompt('person is walking forward'));

    // ===== CONNECTION INITIALIZATION =====
    (async () => {
      try {
        // Load clothing configuration
        await loadClothingConfig();

        console.log('Connecting to Odyssey...');

        await client.connect({
          onConnected: (mediaStream) => {
            console.log('Connected! Media stream received');
            videoEl.srcObject = mediaStream;
            isConnected = true;

            // Try to auto-start if image already uploaded
            checkAutoStart();
          },

          onStatusChange: (status, message) => {
            console.log('Status change:', status, message);
          },

          onStreamStarted: (streamId) => {
            console.log('Stream started, ID:', streamId);
            isStreaming = true;
            updateButtonStates();
          },

          onStreamEnded: () => {
            console.log('Stream ended');
            isStreaming = false;
            updateButtonStates();
          },

          onError: (error, fatal) => {
            console.error('Error:', error.message, 'Fatal:', fatal);
            alert(`Error: ${error.message}`);
          },

          onStreamError: (reason, message) => {
            console.error('Stream error:', reason, message);
            alert(`Stream error: ${message}`);
          }
        });

      } catch (error) {
        console.error('Connection failed:', error);
        alert(`Failed to connect: ${error.message}`);
      }
    })();
  </script>
</body>

</html>